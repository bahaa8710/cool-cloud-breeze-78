{%- assign current_variant = product.selected_or_first_available_variant -%}

<!-- Product Section -->
<section class="product-section">
    <div class="container">
        <div class="product-grid">
            <!-- Product Media Gallery -->
            <div class="product-images">
                {% render 'product-media-gallery', 
                    product: product, 
                    variant: current_variant, 
                    show_thumbnails: true, 
                    enable_image_zoom: true,
                    enable_video_looping: false
                %}
                
                <div class="product-badges">
                    <div class="badge">
                        <span class="badge-dot"></span>
                        <span>{{ section.settings.product_badge | default: 'Nouveau' }}</span>
                    </div>
                    {%- if current_variant.compare_at_price > current_variant.price -%}
                      {%- assign discount = current_variant.compare_at_price | minus: current_variant.price | times: 100 | divided_by: current_variant.compare_at_price -%}
                      <div class="urgency-badge">
                        <span class="urgency-dot"></span>
                        <span>-{{ discount }}%</span>
                      </div>
                    {%- endif -%}
                </div>
            </div>

            <!-- Product Info -->
            <div class="product-info">
                <h1>{{ product.title }}</h1>
                
                {%- if product.metafields.reviews.rating.value != blank -%}
                  <div class="rating">
                      <div class="stars">
                          {%- assign rating = product.metafields.reviews.rating.value | round -%}
                          {%- for i in (1..5) -%}
                            {%- if i <= rating -%}
                              <span>⭐</span>
                            {%- endif -%}
                          {%- endfor -%}
                      </div>
                      <span class="rating-text">({{ product.metafields.reviews.rating.value }}/5 - {{ product.metafields.reviews.rating_count.value | default: '127' }} avis)</span>
                  </div>
                {%- else -%}
                  <div class="rating">
                      <div class="stars">
                          <span>⭐</span><span>⭐</span><span>⭐</span><span>⭐</span><span>⭐</span>
                      </div>
                      <span class="rating-text">({{ section.settings.default_rating | default: '4.9/5 - 127 avis' }})</span>
                  </div>
                {%- endif -%}

                <div class="price-card">
                    <div class="price-info">
                        {%- if current_variant.compare_at_price > current_variant.price -%}
                          <span class="old-price-large">{{ current_variant.compare_at_price | money }}</span>
                        {%- endif -%}
                        <span class="new-price-large" id="price-{{ section.id }}">{{ current_variant.price | money }}</span>
                    </div>
                    {%- if current_variant.compare_at_price > current_variant.price -%}
                      {%- assign savings = current_variant.compare_at_price | minus: current_variant.price -%}
                      {%- assign discount = savings | times: 100 | divided_by: current_variant.compare_at_price -%}
                      <p class="savings">Économisez {{ savings | money }} ({{ discount }}%)</p>
                    {%- endif -%}
                    <div class="shipping-free">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="1" y="3" width="15" height="13"/>
                            <polygon points="16,6 20,6 23,11 23,16 16,16"/>
                            <circle cx="5.5" cy="18.5" r="2.5"/>
                            <circle cx="18.5" cy="18.5" r="2.5"/>
                        </svg>
                        {{ section.settings.shipping_text | default: 'Livraison gratuite' }}
                    </div>
                </div>

                <div class="product-description">
                    {{ product.description | truncatewords: 50 }}
                </div>

                <!-- Product Form Dawn Structure -->
                <product-form class="product-form" data-section="{{ section.id }}">
                  <div class="product-form__error-message-wrapper" role="alert" hidden>
                    <svg aria-hidden="true" focusable="false" class="icon icon-error" viewBox="0 0 13 13">
                      <circle cx="6.5" cy="6.50049" r="5.5" stroke="white" stroke-width="2"/>
                      <circle cx="6.5" cy="6.5" r="5.5" fill="#EB001B" stroke="#EB001B" stroke-width="0.7"/>
                      <path d="m5.87413 3.52832 5.6635 9.5737c.24749.42626.02049.96966-.49134.96966H2.65893c-.51183 0-.73883-.54341-.49134-.96966l5.6635-9.5737a.50033.50033 0 0 1 .87654 0Z" fill="white"/>
                      <path d="m4.19583 7.00049-.71184 3.8984c-.02951.16234.08112.30135.24885.30135h2.51632c.16773 0 .27836-.13901.24885-.30135L6.80417 7.00049H4.19583Z" fill="#EB001B"/>
                    </svg>
                    <span class="product-form__error-message"></span>
                  </div>

                  {%- form 'product', product, id: 'product-form-{{ section.id }}', class: 'form', novalidate: 'novalidate', data-type: 'add-to-cart-form' -%}
                    <input type="hidden" name="form_type" value="product">
                    <input type="hidden" name="utf8" value="✓">
                    <input type="hidden" name="id" value="{{ current_variant.id }}" disabled>
                    
                    <!-- Script avec données produit pour JavaScript -->
                    <script type="application/json" id="product-json-{{ section.id }}">
                      {{ product.variants | json }}
                    </script>

                    <!-- Sélecteur de variantes Dawn -->
                    {% unless product.has_only_default_variant %}
                      {% render 'product-variant-picker', product: product, block: block, product_form_id: 'product-form-{{ section.id }}' %}
                    {% endunless %}

                    <!-- Sélecteur de quantité -->
                    {%- if section.settings.show_quantity_selector != false -%}
                      <div class="product-form__input product-form__quantity quantity-selector">
                        <label class="form__label" for="Quantity-{{ section.id }}">{{ section.settings.quantity_label | default: 'Quantité' }}</label>
                        <quantity-input class="quantity quantity-input" data-url="{{ product.url }}" data-section="{{ section.id }}">
                          <button class="quantity__button no-js-hidden qty-minus" name="minus" type="button">
                            <span class="visually-hidden">{{ 'products.product.quantity.decrease' | t: product: product.title | escape }}</span>
                            {% render 'icon-minus' %}
                          </button>
                          <input 
                            class="quantity__input" 
                            type="number" 
                            name="quantity" 
                            id="Quantity-{{ section.id }}" 
                            data-quantity-variant-id="{{ current_variant.id }}"
                            min="1" 
                            value="1"
                            form="product-form-{{ section.id }}"
                          >
                          <button class="quantity__button no-js-hidden qty-plus" name="plus" type="button">
                            <span class="visually-hidden">{{ 'products.product.quantity.increase' | t: product: product.title | escape }}</span>
                            {% render 'icon-plus' %}
                          </button>
                        </quantity-input>
                      </div>
                    {%- endif -%}

                    <!-- Boutons d'achat -->
                    <div class="product-form__buttons">
                      <button 
                        type="submit" 
                        name="add" 
                        id="ProductSubmitButton-{{ section.id }}"
                        class="product-form__submit button button--primary btn-buy btn-add-to-cart"
                        {%- if product.selected_or_first_available_variant.available == false -%}disabled{%- endif -%}
                      >
                        <span>
                          {%- if product.selected_or_first_available_variant.available -%}
                            {{ section.settings.add_to_cart_text | default: 'Ajouter au panier' }}
                          {%- else -%}
                            {{ section.settings.sold_out_text | default: 'Rupture de stock' }}
                          {%- endif -%}
                        </span>
                        {%- render 'loading-spinner' -%}
                      </button>

              <!-- Acheter maintenant -->
              {%- if section.settings.show_buy_now_button -%}
                <button 
                  type="button" 
                  name="buy_now" 
                  class="product-form__buy-now button button--secondary btn-buy-now"
                  {%- if product.selected_or_first_available_variant.available == false -%}disabled{%- endif -%}
                >
                  {{ section.settings.buy_now_text | default: 'Acheter maintenant' }}
                </button>
              {%- endif -%}

                      <!-- Checkout dynamique -->
                      {%- if section.settings.show_dynamic_checkout -%}
                        {{ form | payment_button }}
                      {%- endif -%}
                    </div>

                    {%- if shop.taxes_included or shop.shipping_policy.body != blank -%}
                      <div class="product-form__tax-line rte">
                        {%- if shop.taxes_included -%}
                          {{ 'products.product.include_taxes' | t }}
                        {%- endif -%}
                        {%- if shop.shipping_policy.body != blank -%}
                          {{ 'products.product.shipping_policy_html' | t: link: shop.shipping_policy.url }}
                        {%- endif -%}
                      </div>
                    {%- endif -%}
                  {%- endform -%}
                </product-form>

                 <!-- Fallback pour JS désactivé -->
                <noscript class="product-form">
                  {%- form 'product', product, class: 'form', novalidate: 'novalidate', data-type: 'add-to-cart-form' -%}
                    <input type="hidden" name="id" value="{{ product.selected_or_first_available_variant.id }}">
                    <button type="submit" name="add" class="btn-buy btn-add-to-cart">
                      <span>
                        {%- if current_variant.available -%}
                          {{ section.settings.add_to_cart_text | default: 'Acheter maintenant' }}
                        {%- else -%}
                          {{ section.settings.sold_out_text | default: 'Rupture de stock' }}
                        {%- endif -%}
                      </span>
                    </button>
                  {%- endform -%}
                </noscript>

            </div>
        </div>
    </div>
</section>

<!-- Chargement des scripts et styles Dawn -->
{{ 'component-product-form.css' | asset_url | stylesheet_tag }}
{{ 'component-product-variant-picker.css' | asset_url | stylesheet_tag }}
{{ 'component-product-media-gallery.css' | asset_url | stylesheet_tag }}
{{ 'variant-radios.js' | asset_url | script_tag }}
{{ 'variant-selects.js' | asset_url | script_tag }}
{{ 'product-form.js' | asset_url | script_tag }}
{{ 'product-buy-now.js' | asset_url | script_tag }}
{{ 'product-media-gallery.js' | asset_url | script_tag }}

<script>
  // Global window properties for Shopify compatibility
  window.product = {{ product | json }};
  window.productVariants = {{ product.variants | json }};

  // Cart routes for Shopify
  window.routes = {
    cart_add_url: '/cart/add',
    cart_change_url: '/cart/change',
    cart_update_url: '/cart/update',
    cart_url: '/cart',
    predictive_search_url: '/search/suggest'
  };

  // Localization strings
  window.variantStrings = {
    addToCart: '{{ section.settings.add_to_cart_text | default: "Ajouter au panier" | escape }}',
    soldOut: '{{ section.settings.sold_out_text | default: "Rupture de stock" | escape }}',
    unavailable: 'Non disponible',
    unitPrice: 'Prix unitaire'
  };
</script>


{% schema %}
{
  "name": "Produit Principal",
  "settings": [
    {
      "type": "text",
      "id": "product_badge",
      "label": "Badge produit",
      "default": "Nouveau"
    },
    {
      "type": "text",
      "id": "default_rating",
      "label": "Note par défaut",
      "default": "4.9/5 - 127 avis"
    },
    {
      "type": "text",
      "id": "shipping_text",
      "label": "Texte livraison",
      "default": "Livraison gratuite"
    },
    {
      "type": "checkbox",
      "id": "show_dynamic_checkout",
      "default": true,
      "label": "Afficher les boutons d'achat rapide"
    },
    {
      "type": "checkbox",
      "id": "show_quantity_selector",
      "default": true,
      "label": "Afficher le sélecteur de quantité"
    },
    {
      "type": "text",
      "id": "quantity_label",
      "default": "Quantité :",
      "label": "Label quantité"
    },
    {
      "type": "text",
      "id": "add_to_cart_text",
      "default": "Ajouter au panier",
      "label": "Texte du bouton Ajouter au panier"
    },
    {
      "type": "text",
      "id": "sold_out_text",
      "default": "Rupture de stock",
      "label": "Texte rupture de stock"
    },
    {
      "type": "checkbox",
      "id": "show_buy_now_button",
      "default": false,
      "label": "Afficher le bouton Acheter maintenant"
    },
    {
      "type": "text",
      "id": "buy_now_text",
      "default": "Acheter maintenant",
      "label": "Texte du bouton Acheter maintenant"
    }
  ],
  "presets": [
    {
      "name": "Produit Principal"
    }
  ]
}
{% endschema %}