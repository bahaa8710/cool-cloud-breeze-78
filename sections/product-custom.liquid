{%- assign current_variant = product.selected_or_first_available_variant -%}

<style>
  .product-custom-section {
    padding: 2rem 0;
  }
  
  .product-grid-custom {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 3rem;
    max-width: 1200px;
    margin: 0 auto;
    padding: 0 1rem;
  }
  
  @media (max-width: 768px) {
    .product-grid-custom {
      grid-template-columns: 1fr;
      gap: 2rem;
    }
  }
</style>

<!-- Navigation -->
<nav class="product-nav">
    <div class="container">
        <a href="{{ routes.root_url }}" class="back-link">← Retour à l'accueil</a>
    </div>
</nav>

<!-- Product Section -->
<section class="product-custom-section">
    <div class="container">
        <div class="product-grid-custom">
            <!-- Product Images -->
            <div class="product-images">
                <div class="main-image">
                    <img id="mainProductImageCustom" 
                         src="{{ current_variant.featured_image | default: product.featured_image | image_url: '800x' }}" 
                         alt="{{ current_variant.featured_image.alt | default: product.featured_image.alt | default: product.title | escape }}"
                         data-current-variant="{{ current_variant.id }}">
                    <div class="product-badges">
                        <span class="badge-new">{{ section.settings.badge_new_text | default: 'Nouveau' }}</span>
                        {%- if current_variant.compare_at_price > current_variant.price -%}
                          {%- assign discount = current_variant.compare_at_price | minus: current_variant.price | times: 100 | divided_by: current_variant.compare_at_price -%}
                          <span class="badge-discount">-{{ discount }}%</span>
                        {%- endif -%}
                    </div>
                </div>
                {%- if product.images.size > 1 -%}
                  <div class="thumbnails">
                      {%- for image in product.images limit: 4 -%}
                        <button class="thumbnail{% if forloop.first %} active{% endif %}" onclick="changeImageCustom({{ forloop.index0 }})">
                            <img src="{{ image | image_url: '400x' }}" alt="{{ image.alt | default: product.title | escape }}">
                        </button>
                      {%- endfor -%}
                  </div>
                {%- endif -%}
            </div>

            <!-- Product Info -->
            <div class="product-info">
                <h1>{{ product.title }}</h1>
                
                {%- if product.metafields.reviews.rating.value != blank -%}
                  <div class="rating">
                      <div class="stars">
                          {%- assign rating = product.metafields.reviews.rating.value | round -%}
                          {%- for i in (1..5) -%}
                            {%- if i <= rating -%}
                              <span>⭐</span>
                            {%- endif -%}
                          {%- endfor -%}
                      </div>
                      <span class="rating-text">({{ product.metafields.reviews.rating.value }}/5 - {{ product.metafields.reviews.rating_count.value | default: '127' }} avis)</span>
                  </div>
                {%- else -%}
                  <div class="rating">
                      <div class="stars">
                          <span>⭐</span><span>⭐</span><span>⭐</span><span>⭐</span><span>⭐</span>
                      </div>
                      <span class="rating-text">(4.9/5 - {{ section.settings.default_reviews_count | default: '127' }} avis)</span>
                  </div>
                {%- endif -%}

                <div class="price-card">
                    <div class="price-info">
                        {%- if current_variant.compare_at_price > current_variant.price -%}
                          <span class="old-price-large">{{ current_variant.compare_at_price | money }}</span>
                        {%- endif -%}
                        <span class="new-price-large" id="price-custom-{{ section.id }}">{{ current_variant.price | money }}</span>
                    </div>
                    {%- if current_variant.compare_at_price > current_variant.price -%}
                      {%- assign savings = current_variant.compare_at_price | minus: current_variant.price -%}
                      {%- assign discount = savings | times: 100 | divided_by: current_variant.compare_at_price -%}
                      <p class="savings">Économisez {{ savings | money }} ({{ discount }}%)</p>
                    {%- endif -%}
                    <div class="shipping-free">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="1" y="3" width="15" height="13"/>
                            <polygon points="16,6 20,6 23,11 23,16 16,16"/>
                            <circle cx="5.5" cy="18.5" r="2.5"/>
                            <circle cx="18.5" cy="18.5" r="2.5"/>
                        </svg>
                        {{ section.settings.shipping_text | default: 'Livraison gratuite' }}
                    </div>
                </div>

                <div class="product-description">
                    {{ section.settings.product_description | default: product.description | truncatewords: 50 }}
                </div>

                <!-- Product Form Dawn Structure -->
                <product-form class="product-form" data-section="{{ section.id }}">
                  <div class="product-form__error-message-wrapper" role="alert" hidden>
                    <svg aria-hidden="true" focusable="false" class="icon icon-error" viewBox="0 0 13 13">
                      <circle cx="6.5" cy="6.50049" r="5.5" stroke="white" stroke-width="2"/>
                      <circle cx="6.5" cy="6.5" r="5.5" fill="#EB001B" stroke="#EB001B" stroke-width="0.7"/>
                      <path d="m5.87413 3.52832 5.6635 9.5737c.24749.42626.02049.96966-.49134.96966H2.65893c-.51183 0-.73883-.54341-.49134-.96966l5.6635-9.5737a.50033.50033 0 0 1 .87654 0Z" fill="white"/>
                      <path d="m4.19583 7.00049-.71184 3.8984c-.02951.16234.08112.30135.24885.30135h2.51632c.16773 0 .27836-.13901.24885-.30135L6.80417 7.00049H4.19583Z" fill="#EB001B"/>
                    </svg>
                    <span class="product-form__error-message"></span>
                  </div>

                  {%- form 'product', product, id: 'product-form-custom-{{ section.id }}', class: 'form', novalidate: 'novalidate', data-type: 'add-to-cart-form' -%}
                    <input type="hidden" name="form_type" value="product">
                    <input type="hidden" name="utf8" value="✓">
                    <input type="hidden" name="id" value="{{ current_variant.id }}" disabled>
                    
                    <!-- Script avec données produit pour JavaScript -->
                    <script type="application/json" id="product-json-custom-{{ section.id }}">
                      {{ product.variants | json }}
                    </script>

                    <!-- Sélecteur de variantes Dawn -->
                    {% unless product.has_only_default_variant %}
                      {% render 'product-variant-picker', product: product, block: block, product_form_id: 'product-form-custom-{{ section.id }}' %}
                    {% endunless %}

                    <!-- Sélecteur de quantité -->
                    <div class="product-form__input product-form__quantity quantity-selector">
                      <label class="form__label" for="QuantityCustom-{{ section.id }}">{{ section.settings.quantity_label | default: 'Quantité' }}</label>
                      <quantity-input class="quantity quantity-input" data-url="{{ product.url }}" data-section="{{ section.id }}">
                        <button class="quantity__button no-js-hidden qty-minus" name="minus" type="button">
                          <span class="visually-hidden">{{ 'products.product.quantity.decrease' | t: product: product.title | escape }}</span>
                          {% render 'icon-minus' %}
                        </button>
                        <input 
                          class="quantity__input" 
                          type="number" 
                          name="quantity" 
                          id="QuantityCustom-{{ section.id }}" 
                          data-quantity-variant-id="{{ current_variant.id }}"
                          min="1" 
                          value="1"
                          form="product-form-custom-{{ section.id }}"
                        >
                        <button class="quantity__button no-js-hidden qty-plus" name="plus" type="button">
                          <span class="visually-hidden">{{ 'products.product.quantity.increase' | t: product: product.title | escape }}</span>
                          {% render 'icon-plus' %}
                        </button>
                      </quantity-input>
                    </div>

                    <!-- Boutons d'achat -->
                    <div class="product-form__buttons">
                      <button 
                        type="submit" 
                        name="add" 
                        id="ProductSubmitButtonCustom-{{ section.id }}"
                        class="product-form__submit button button--primary btn-buy btn-add-to-cart"
                        {%- if product.selected_or_first_available_variant.available == false -%}disabled{%- endif -%}
                      >
                        <span>
                          {%- if product.selected_or_first_available_variant.available -%}
                            {{ section.settings.add_to_cart_text | default: 'Ajouter au panier' }}
                          {%- else -%}
                            {{ section.settings.sold_out_text | default: 'Rupture de stock' }}
                          {%- endif -%}
                        </span>
                        {%- render 'loading-spinner' -%}
                      </button>

                      <!-- Acheter maintenant -->
                      {%- if section.settings.show_buy_now_button -%}
                        <button 
                          type="button" 
                          name="buy_now" 
                          class="product-form__buy-now button button--secondary btn-buy-now"
                          {%- if product.selected_or_first_available_variant.available == false -%}disabled{%- endif -%}
                        >
                          {{ section.settings.buy_now_text | default: 'Acheter maintenant' }}
                        </button>
                      {%- endif -%}
                    </div>
                  {%- endform -%}
                </product-form>

                <!-- Dynamic Checkout Buttons (Shop Pay, etc.) -->
                {%- if settings.show_dynamic_checkout -%}
                {%- form 'product', product, id: 'BuyNowFormCustom', class: 'dynamic-checkout-form' -%}
                    <input type="hidden" name="id" value="{{ current_variant.id }}">
                    <input type="hidden" name="quantity" value="1">
                    
                    <div class="dynamic-checkout-section">
                        <div class="shopify-payment-button" data-shopify="payment-button">
                            {{ form | payment_button }}
                        </div>
                    </div>
                {%- endform -%}
                {%- endif -%}

                <!-- Features -->
                {%- if section.settings.show_features -%}
                  <div class="features-card">
                      <div class="feature">
                          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                              <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
                          </svg>
                          <span>{{ section.settings.feature_1 | default: 'Garantie 30 jours satisfait ou remboursé' }}</span>
                      </div>
                      <div class="feature">
                          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                              <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
                          </svg>
                          <span>{{ section.settings.feature_2 | default: 'Paiement 100% sécurisé' }}</span>
                      </div>
                      <div class="feature">
                          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                              <rect x="1" y="3" width="15" height="13"/>
                              <polygon points="16,6 20,6 23,11 23,16 16,16"/>
                              <circle cx="5.5" cy="18.5" r="2.5"/>
                              <circle cx="18.5" cy="18.5" r="2.5"/>
                          </svg>
                          <span>{{ section.settings.feature_3 | default: 'Livraison gratuite en France' }}</span>
                      </div>
                      <div class="feature">
                          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                              <polyline points="1 4 1 10 7 10"/>
                              <path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"/>
                          </svg>
                          <span>{{ section.settings.feature_4 | default: 'Stock limité - Commandez vite !' }}</span>
                      </div>
                  </div>
                {%- endif -%}
            </div>
        </div>
    </div>
</section>

<script>
  // Store color configuration for this section
  window.customColorConfig{{ section.id }} = {
    {%- for block in section.blocks -%}
      {%- case block.type -%}
        {%- when 'color_option' -%}
          '{{ block.settings.color_key }}': {
            variantId: '{{ block.settings.variant_id }}',
            image: '{{ block.settings.color_image | image_url: '800x' }}',
            name: '{{ block.settings.color_name }}'
          }{%- unless forloop.last -%},{%- endunless -%}
      {%- endcase -%}
    {%- endfor -%}
  };

  // Product images array for this section
  const productImagesCustom{{ section.id }} = [
    {%- for image in product.images -%}
      "{{ image | image_url: '800x' }}"{%- unless forloop.last -%},{%- endunless -%}
    {%- endfor -%}
  ];
</script>

<!-- Chargement des scripts et styles Dawn -->
{{ 'component-product-form.css' | asset_url | stylesheet_tag }}
{{ 'component-product-variant-picker.css' | asset_url | stylesheet_tag }}
{{ 'variant-radios.js' | asset_url | script_tag }}
{{ 'variant-selects.js' | asset_url | script_tag }}
{{ 'product-form.js' | asset_url | script_tag }}
{{ 'product-buy-now.js' | asset_url | script_tag }}

<script>
  // Cart routes for Shopify
  window.routes = {
    cart_add_url: '/cart/add',
    cart_change_url: '/cart/change',
    cart_update_url: '/cart/update',
    cart_url: '/cart',
    predictive_search_url: '/search/suggest'
  };

  // Localization strings
  window.variantStrings = {
    addToCart: '{{ section.settings.add_to_cart_text | default: "Ajouter au panier" | escape }}',
    soldOut: '{{ section.settings.sold_out_text | default: "Rupture de stock" | escape }}',
    unavailable: 'Non disponible',
    unitPrice: 'Prix unitaire'
  };
</script>

{% schema %}
{
  "name": "Produit personnalisé",
  "tag": "section",
  "class": "section",
  "settings": [
    {
      "type": "text",
      "id": "badge_new_text",
      "label": "Texte badge nouveau",
      "default": "Nouveau"
    },
    {
      "type": "text",
      "id": "shipping_text", 
      "label": "Texte livraison",
      "default": "Livraison gratuite"
    },
    {
      "type": "textarea",
      "id": "product_description",
      "label": "Description produit personnalisée",
      "info": "Laissez vide pour utiliser la description du produit"
    },
    {
      "type": "text",
      "id": "color_label",
      "label": "Label sélecteur couleur",
      "default": "Couleur"
    },
    {
      "type": "text",
      "id": "quantity_label",
      "label": "Label quantité",
      "default": "Quantité"
    },
    {
      "type": "text",
      "id": "buy_button_text",
      "label": "Texte bouton achat",
      "default": "Acheter maintenant"
    },
    {
      "type": "text",
      "id": "sold_out_text",
      "label": "Texte rupture de stock",
      "default": "Rupture de stock"
    },
    {
      "type": "text",
      "id": "default_reviews_count",
      "label": "Nombre d'avis par défaut",
      "default": "127"
    },
    {
      "type": "checkbox",
      "id": "show_features",
      "label": "Afficher les caractéristiques",
      "default": true
    },
    {
      "type": "text",
      "id": "feature_1",
      "label": "Caractéristique 1",
      "default": "Garantie 30 jours satisfait ou remboursé"
    },
    {
      "type": "text",
      "id": "feature_2",
      "label": "Caractéristique 2", 
      "default": "Paiement 100% sécurisé"
    },
    {
      "type": "text",
      "id": "feature_3",
      "label": "Caractéristique 3",
      "default": "Livraison gratuite en France"
    },
    {
      "type": "text",
      "id": "feature_4",
      "label": "Caractéristique 4",
      "default": "Stock limité - Commandez vite !"
    },
    {
      "type": "text",
      "id": "add_to_cart_text",
      "default": "Ajouter au panier",
      "label": "Texte du bouton Ajouter au panier"
    },
    {
      "type": "text",
      "id": "sold_out_text",
      "default": "Rupture de stock",
      "label": "Texte rupture de stock"
    },
    {
      "type": "checkbox",
      "id": "show_buy_now_button",
      "default": false,
      "label": "Afficher le bouton Acheter maintenant"
    },
    {
      "type": "text",
      "id": "buy_now_text",
      "default": "Acheter maintenant",
      "label": "Texte du bouton Acheter maintenant"
    }
  ],
  "blocks": [
    {
      "type": "color_option",
      "name": "Option couleur",
      "settings": [
        {
          "type": "text",
          "id": "color_name",
          "label": "Nom de la couleur",
          "default": "Blanc"
        },
        {
          "type": "text",
          "id": "color_key",
          "label": "Clé couleur (pour CSS)",
          "default": "white",
          "info": "Utilisez: white, black, pink, blue"
        },
        {
          "type": "text",
          "id": "variant_id",
          "label": "ID de la variante Shopify",
          "info": "ID numérique de la variante dans Shopify"
        },
        {
          "type": "image_picker",
          "id": "color_image",
          "label": "Image pour cette couleur"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Produit personnalisé",
      "blocks": [
        {
          "type": "color_option",
          "settings": {
            "color_name": "Blanc",
            "color_key": "white"
          }
        },
        {
          "type": "color_option", 
          "settings": {
            "color_name": "Noir",
            "color_key": "black"
          }
        },
        {
          "type": "color_option",
          "settings": {
            "color_name": "Rose",
            "color_key": "pink"
          }
        },
        {
          "type": "color_option",
          "settings": {
            "color_name": "Bleu",
            "color_key": "blue"
          }
        }
      ]
    }
  ]
}
{% endschema %}